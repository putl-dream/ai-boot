# 权限与角色管理设计方案

本方案基于 **RBAC（Role-Based Access Control）** 与 **ABAC（Attribute-Based Access Control）** 模型，结合 Spring 框架特性，实现多层级的权限控制体系，包括功能级与数据级权限校验。

---

## 一、功能权限管理（RBAC）

### 1. 权限流程概览

#### 用户登录阶段
- 用户通过登录接口进行身份验证。
- 登录成功后，系统从数据库或缓存中加载用户的角色信息。
- 将角色信息注册到用户请求上下文中，以便后续业务逻辑使用。

#### 用户访问功能阶段
- 功能模块（或接口）声明所需权限。
- 系统根据用户角色所拥有的权限进行判断：
    - ✅ 若符合：放行请求。
    - ❌ 若不符合：拒绝访问并返回无权限提示。

#### 系统初始化阶段
- Spring 启动时，通过扫描 Bean 或自定义接口，自动收集所有带有权限注解或实现特定接口的功能模块。
- 将这些功能模块信息写入数据库，形成统一的「功能点」数据表。

#### 管理员操作阶段
- 管理员可通过系统管理界面对角色与功能点进行关联配置。
- 支持动态分配、撤销角色权限，维护角色与功能的对应关系。

---

### 2. 权限细节设计

#### （1）功能收集机制
系统启动时，扫描所有实现自定义接口 `PermissionFunction`（或标注特定注解）的 Bean：
- 将其注册到 `List<PermissionFunction>` 中；
- 初始化阶段批量写入数据库；
- 默认创建：
    - **超级管理员角色**（拥有全部权限）；
    - **普通管理员角色**（拥有基础权限）。

新用户注册时，系统会为其自动分配默认角色。

#### （2）角色与权限的动态管理
管理员登录后可：
- 管理角色；
- 为角色分配或撤销功能；
- 当用户角色或权限变更时，系统更新统一的 **权限版本号（timestamp / version）**。

#### （3）业务层权限校验
业务处理过程中：
- 每个请求携带用户上下文信息；
- 进入业务逻辑前，执行权限验证；
- 校验通过后继续执行，否则抛出拒绝访问异常。

#### （4）权限缓存与版本控制
1. 用户登录后，系统进行 Token 校验；
2. 校验通过后，对比：
    - 用户缓存的权限版本号；
    - 系统最新权限版本号；
3. 若版本不一致：
    - 返回指定错误码；
    - 前端触发重新拉取最新 Token；
    - 后端同步更新 Redis 中的权限缓存；
4. 若版本一致：
    - 直接从 Redis 获取用户权限信息；
    - 若缓存失效，则从数据库加载并更新缓存。

---

## 二、数据层权限管理（ABAC）

在功能层校验基础上，进一步在 **数据访问层（Data Access Layer）** 实现细粒度权限控制。  
该机制基于 **属性驱动（Attribute-Based Access Control, ABAC）**，常应用于行级或列级安全控制中。

### 1. 基本思想

数据访问不仅依赖“是否拥有该功能权限”，还需基于以下属性进行判断：
- 数据所有者（Owner）
- 数据类型（Type）
- 数据标签（Tag）
- 数据可见级别（Access Level）
- 用户所属群组（Group）

### 2. 示例代码

```java
// Service 或 Mapper 层示例
String sql = "SELECT * FROM model_types WHERE 1=1";

// 1. 普通用户：仅能查看自己的数据或公开数据
if (!user.isAdmin()) {
    sql += " AND (owner_id = #{userId} OR access_level = 'public')";
}

// 2. 管理员：无访问限制
// if (user.isAdmin()) → 不附加任何条件

// 3. 群组共享（可选）
if (user.hasGroup(1001)) {
    sql += " AND (group_id = 1001 OR access_level IN ('group', 'public'))";
}
```
### 3. 数据层权限要点
- 数据鉴权逻辑嵌入到 Mapper 查询或 Service 层；
- 与功能权限不同，数据层鉴权不判断“是否有权访问接口”，而是限定“可访问的数据范围”；
- 通常可通过 SQL 拼接、动态条件构建器或 MyBatis 拦截器实现。

| 层级  | 模型          | 说明                |
| --- | ----------- | ----------------- |
| 功能层 | RBAC        | 基于角色与功能点的访问控制     |
| 数据层 | ABAC        | 基于属性的行级/列级访问限制    |
| 缓存层 | Redis       | 缓存用户权限信息与版本号      |
| 管理层 | Web UI      | 管理员维护角色、功能、权限映射关系 |
| 安全层 | Token + 版本号 | 确保权限数据与用户会话同步更新   |
